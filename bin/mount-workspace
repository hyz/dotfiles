#!/bin/bash
## workspace Downloads Music Movies Pictures Documents Desktop

die() {
    xcode=$?
    echo >&2 $*
    exit $xcode
}

if [[ "`id -ru`" = 0 ]] ; then
    finalize() {
        [ $? -eq 0 ] || umount workspace
    }
    trap finalize INT TERM EXIT

    echo >&2 -e "$* \t: $(id) \tSUDO_USER=$SUDO_USER \t: $(pwd) "

    for xd in $* ; do
        xs=`basename $xd`
        echo >&2 "bind: workspace/$xs $xd"
        mount -o bind workspace/$xs $xd || exit # die "workspace/$xs $xd"
    done

    exit
fi

DEST=${DEST:-.}
ARGS=`getopt -o t:V --long target-directory:,help,version -- $@` || exit 1

eval set -- "$ARGS" # ; echo "$@"
while true ; do
    case "$1" in
        -t|--target-directory) DEST="${2%/}" ; shift 2 ;;
        -V|--version) Version ; exit ;;
        --help) Help ; exit ;;
        --) shift ; break ;;
        *) die "$@" ; exit 1 ;;
    esac
done
[ -d "$DEST" ] || die "$DEST"
#echo >&2 -e "DIR: $DEST \t--: $*"

sudo mount workspace || exit
trap 'sudo umount workspace' INT TERM EXIT

for xd in $* ; do
    xs=`basename $xd`
    [ -d "workspace/$xs" ] || die $BASH_LINENO "workspace/$xs"
    [ -d "$xd" ] || mkdir $xd || die $BASH_LINENO "$xd"
done

exec sudo DEST=$DEST /bin/bash $0 $*

#/bin/cat << @EoF | sudo /bin/bash -
#    Should not reachable
#@EoF

